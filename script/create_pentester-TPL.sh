#!/bin/bash

pct shutdown 200
pct destroy 200

pct create 200 local:vztmpl/debian-11-standard_11.7-1_amd64.tar.zst --hostname pentester-TPL --password 'Pa$$w0rd' --rootfs local-lvm:2 --cores 1 --net0 name=eth0,bridge=vmbr0,firewall=1,ip=dhcp --unprivileged 1 --features nesting=1 --start 1
pct exec 200 -- bash -c 'sed -i "s/#PermitRootLogin prohibit-password/PermitRootLogin yes/" /etc/ssh/sshd_config && systemctl restart ssh'
pct exec 200 -- bash -c 'mkdir -p /root/.ssh/'

while [[ -z $(lxc-info -n 200 | awk '$0 ~ /^IP/ { print $2 }') ]]
do
  sleep 0.5
done

lxc-info -n 200 | awk '$0 ~ /^IP/ { print $2 }' > /root/penlab/.container/TPL/pentester/ip
( cat /root/penlab/.container/TPL/pentester/ip ; echo ' ansible_user=root' ) | tr -d '\n' > /root/penlab/.ansible/inventory/pentester.cfg
echo -e '\r' >> /root/penlab/.ansible/inventory/pentester.cfg

$(( echo 'sshpass -p Pa$$w0rd ssh-copy-id -o StrictHostKeyChecking=no -i /root/.ssh/ansible.pub root@' ; cat /root/penlab/.container/TPL/pentester/ip ) | tr -d '\n')

ansible-playbook -i /root/penlab/.ansible/inventory/pentester.cfg /root/penlab/.ansible/playbook/pentester.yml --private-key /root/.ssh/ansible

pct shutdown 200
pct template 200
